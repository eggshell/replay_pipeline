---
- name: Ensure venv directory
  file:
    path: /opt/venvs
    state: directory

- name: Ensure pip
  apt:
    name: python-pip
    update_cache: yes
    cache_valid_time: 3600

- name: Ensure virtualenv
  pip:
    name: virtualenv
    state: present

- name: Ensure openstack clients
  pip:
    name: "{{ item }}"
    state: present
    virtualenv: /opt/venvs/replays
  with_items:
    - python-keystoneclient
    - python-swiftclient
    - git+https://github.com/nibalizer/replay_processing.git

- name: Ensure directories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /opt/scripts
    - /opt/replays/replays_unprocessed
    - /opt/replays/replays_processed

- name: Ensure scripts
  template:
    src: "opt/replays/scripts/{{ item }}"
    dest: "/opt/replays/scripts/{{ item }}"
  with_items:
    - openrc.sh
    - pull-replays.sh
    - process-replays.sh
    - push-replay-data.sh

- name: Ensure initial starcraft_replays.csv
  copy:
    src: opt/replays/starcraft_header.csv
    dest: /opt/replays/starcraft_replays.csv
    force: no

- name: Ensure replay pull cron job
  cron:
    name: "Pull replay files from object store"
    job: "/opt/replays/scripts/pull-replays.sh"

- name: Ensure replay processing cron job
  cron:
    name: "Process replays locally"
    job: "/opt/replays/scripts/process-replays.sh"

- name: Ensure replay push cron job
  cron:
    name: "Push replays to watson analytics"
    job: "/opt/replays/scripts/push-replays.sh"
